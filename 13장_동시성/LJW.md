> "객체는 처리의 추상화다. 스레드는 일정의 추상화다." -제임스 O.코플리엔   
> 동시성과 깔끔한 코드는 양립하기 아주 어렵다.   

***
## 동시성이 필요한 이유?
> 결함을 없애는 전략   
> 무엇과 언제를 분리하는 전략   
> 무엇과 언제를 분리하면 애플리케이션 구조와 효율이 극적으로 나아짐   

### 미신과 오해
	반드시 동시성 필요한 상황 존재 -> 동시성은 어렵다!
> 동시성과 관련된 일반적인 미신과 오해
* 동시성은 항상 성능을 높여준다? => 때로!
* 동시성을 구현해도 설계는 변하지 않는다? => 무엇과 언제를 분리하면 시스템 구조 크게 달라짐
* 웹 또는 EJB 컨테이너 사용하면 동시성 이해할 필요X? => 알아야 한다!
	
> 동시성과 관련된 타당한 생각 몇 가지 
* 동시성은 다소 부하를 유발
* 동시성은 복잡함
* 일반적으로 동시성 버그는 재현하기 어려움
* 동시성 구현하려면 흔히 근본적 설계 전략 재고해야 함

***
# 난관
## 동시성 방어 원칙
### 단일 책임 원칙 : 주어진 메서드/클래스/컴포넌트를 변경할 이유가 하나여야 한다
* 동시성 코드는 독자적인 개발, 변경, 조율 주기 있음
* 동시성 코드에는 독자적 난관O. 다른 코드에서 겪는 난관보다 어려움
* 잘못 구현한 동시성 코드는 별의별 방식으로 실패. 
* 권장사항: 동시성 코드는 다른 코드와 분리하라!


### 따름 정리: 자료 범위를 제한하라
> 공유객체 사용하는 코드 내 임계영역을 synchronized 키워드로 보호 권장 -> 임계영역 수 줄이는 기술 중요
> 공유 자료 수정하는 위치 많을수록 커지는 가능성...
* 보호할 임계영역 빼먹음 -> 공유 자로 수정하는 모든 코드 망가뜨림
* 모든 임계영역을 올바로 보호했는지 확인하느라 똑같은 노력과 수고 반복
* 그렇지 않아도 찾아내기 힘든 버그 더 찾기 어려움
* 권장사항: 자료를 캡슐화하라. 공유 자료 최대한 줄여라.


### 따름 정리: 자료 사본을 사용하라
	공유 자료 줄이려면? 
* 처음부터 공유하지 않는 방법 Best
* 객체 복사해서 읽기 전용으로 사용하는 방법
* 각 스레드가 객체를 복사해 사용한 후 스레드가 해당 사본에서 결과 가져오는 방법
> 사본으로 동기화 피하기


### 따름 정리: 스레드는 가능한 독립적으로 구현하라
> 자신만의 세상에 존재하는 스레드 구현! 다른 스레드와 자료 공유X
* 권장사항: 독자적인 스레드로, 가능하면 다른 프로세서에서, 돌려도 괜찮도록 자료를 독립적인 단위로 분할하라

***
## 라이브러리를 이해하라
* 스레드 환경에 안전한 컬렉션 사용 -> 자바5부터 제공
* 서로 무관한 작업을 수행할 때는 executor 프레임워크 사용
* 가능하다면 스레드가 차단되지 않는 방법 사용
* 일부 클래스 라이브러리는 스레드에 안전하지 못함

### 스레드 환경에 안전한 컬렉션
* java.util.concurrent 패키지가 제공하는 클래스 -> 다중 스레드 환경에서 사용해도 안전, 성능 좋음
* ReentrantLock
* Semaphore
* CountDownLatch
* 권장사항: 언어가 제공하는 클래스 검토하라. java.util.concurrent, java.util.concurrent.atomic, java.util.concurrent.locks

***
## 실행 모델을 이해하라
몇가지 기본 용어
* 한정된 자원 : 다중 스레드 환경에서 사용하는 자원, 크기나 숫자 제한적. 데이터베이스 연결, 길이가 일정한 읽기/쓰기 버퍼 등.
* 상호 배제 : 한 번에 한 스레드만 공유 자료나 공유 자원 사용할 수 있는 경우.
* 기아 : 한 스레드나 여러 스레드가 굉장히 오랫동안 혹은 영원히 자원 기다림.
* 데드락 : 여러 스레드가 서로 끝나기를 기다림. 모든 스레드가 각기 필요한 자원을 다른 스레드가 점유하는 바람에 어느 쪽도 더 진행X
* 라이브락 : 락을 거는 단계에서 각 스레드가 서로 방해. 스레드는 계속해서 진행하려 하지만, 공명으로 인해 굉장히 오랫동안 혹은 영원히 진행X

### 다중 스레드 프로그래밍에서 사용하는 실행 모델 몇 가지
* 생산자-소비자
* 읽기-쓰기
* 식사하는 철학자들
> 권장사항 : 위에서 설명한 기본 알고리즘과 각 해법 이해!

***
## 동기화하는 메서드 사이에 존재하는 의존성 이해하라
> 권장사항 : 공유 객체 하나에는 메서드 하나만 사용하라
공유 객체 하나에 여러 메서드가 필요한 상황에는 다음 세 가지 방법 고려
* 클라이언트에서 잠금 - 클라이언트에서 첫 번째 메서드 호출하기 전에 서버 잠금. 마지막 메서드를 호출할 때까지 잠금 유지.
* 서버에서 잠금 - 서버에다 "서버를 잠그고 모든 메서드 호출한 후 잠금 해제" 메서드 구현. 클라이언트는 이 메서드 호출.
* 연결 서버 - 잠금 수행하는 중간 단계 생성. '서버에서 잠금' 방식과 유사하지만 원래 서버 변경X
***
## 동기화하는 부분 작게 만들어라
> 임계영역은 반드시 보호해야 한다. 따라서, 코드 짤 때는 임계영역 수를 최대한 줄여야 한다.   
> 권장사항: 동기화하는 부분 최대한 작게!   
***
## 올바른 종료 코드는 구현하기 어렵다
> 깔끔하게 종료하는 코드 올바로 구현하기 어려움... 가장 흔히 발생하는 문제 "데드락"   
> 권장사항 : 종료 코드를 개발 초기부터 고민하고 동작하게 초기부터 구현하라. 생각보다 오래 걸린다. 생각보다 어려우므로 이미 나온 알고리즘 검토하라.   
***
## 스레드 코드 테스트하기
> 권장사항: 문제를 노출하는 테스트 케이스 작성하라. 프로그램 설정과 시스템 설정과 부하 바꿔가며 자주 돌려라. 테스트가 실패하면 원인 추척하라. 
몇 가지 구체적인 지침
* 말이 안 되는 실패는 잠정적인 스레드 문제로 취급
* 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자
* 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있도록 스레드 코드 구현
* 다중 스레드를 쓰는 코드 부분을 상황에 맞춰 조정할 수 있게 작성
* 프로세서 수보다 많은 스레드 돌려보라
* 다른 플랫폼에서 돌려보라
* 코드에 보조 코드를 넣어 돌려라. 강제로 실패를 일으키게 해보라.

### 말이 안 되는 실패는 잠정적인 스레드 문제로 취급하라
	'일회성' 문제 계속 무시하면 잘못된 코드 위에 코드가 계속 쌓임
> 권장사항 : 시스템 실패를 '일회성'이라 치부하지 마라.

### 다중 스레드를 고려하지 않은 순차 코드부터 제대로 돌게 만들자.
	스레드 환경 밖에서 코드가 제대로 도는지 반드시 확인.
	스레드가 호출하는 POJO 만들기 -> 스레드 환경 밖에서 테스트 가능 , POJO에 넣는 코드 많을수록 좋음
> 권장사항 : 스레드 환경 밖에서 생기는 버그와 스레드 환경에서 생기는 버그를 동시에 디버깅하지 마라. 먼저 스레드 환경 밖에서 코드를 올바로 돌려라.

### 다중 스레드를 쓰는 코드 부분을 다양한 환경에 쉽게 끼워 넣을 수 있게 스레드 코드를 구현하라.
* 한 스레드로 실행하거나, 여러 스레드로 실행하거나, 실행 중 스레드 수를 바꿔본다.
* 스레드 코드를 실제 환경이나 테스트 환경에서 돌려본다.
* 테스트 코드를 빨리, 천천히, 다양한 속도로 돌려본다.
* 반복 테스트가 가능하도록 테스트 케이스 작성한다.
> 권장사항 : 다양한 설정에서 실행할 목적으로 다른 환경에 쉽게 끼워 넣을 수 있게 코드 구현.

### 다중 스레드를 쓰는 코드 부분을 상황에 맞게 조율할 수 있게 작성하라
> 적절한 스레드 개수 파악하려면 상당한 시행착오 필요.   
> 처음부터 다양한 설정으로 프로그램 성능 측정 방법 구현.   

### 프로세서 수보다 많은 스레드 돌려보라.
> 시스템이 스레드를 스와핑 할 때도 문제 발생. 스와핑 일으키려면 프로세서 수보다 많은 스레드 돌림.   
> 스와핑 잦을수록 임계영역 빼먹은 코드나 데드락 일으키는 코드 찾기 쉬워짐.   

### 다른 플랫폼에서 돌려보라
> 코드가 돌아갈 가능성 있는 플랫폼 전부에서 테스트 수행해야 마땅   
> 권장사항 : 처음부터 그리고 자주 모든 목표 플랫폼에서 코드 돌려라.   

### 코드에 보조 코드를 넣어 돌려라. 강제로 실패를 일으키게 해보라.
> 스레드 오류는 찾기 어려움 -> 보조 코드 추가해 실행 순서 바꿔주기   
보조 코드 추가하는 방법
* 직접 구현하기 : 코드에다 직접 wait(), sleep(), yield(), priority() 함수 추가. 
* 자동화 : 보조 코드 자동으로 추가하려면 AOF, CGLIB, ASM 과 같은 도구 사용.
> 권장사항: 흔들기 기법을 사용해 오류 찾아내라.

***
## 결론
* 다중 스레드 코드는 올바로 구현하기 어렵다.
* 무엇보다 먼저, SRP 준수.
* POJO 사용해 스레드를 아는 코드와 스레드를 모르는 코드를 분리. -> 스레드 코드는 최대한 집약되고 작아야 한다.
* 동시성 오류 일으키는 잠정적 원인 철저히 이해
* 사용하는 라이브러리와 기본 알고리즘 이해
* 보호할 코드 영역 찾아내는 방법과 특정 코드 영역 잠그는 방법 이해
* 스레드 코드는 많은 플랫폼에서 많은 설정으로 반복해서 계속 테스트해야 한다.
* 시간을 들여 보조 코드를 추가하면 오류가 드러날 가능성이 크게 높아진다. 직접 구현도 OK. 몇 가지 자동화 기술도 OK. 초반부터 고려.
* 깔끔한 접근 방식을 취한다면 코드가 올바로 돌아갈 가능성이 극적으로 높아진다.
